# Persona Mismatch Bug Fix - Implementation Summary

**Date**: November 29, 2025  
**Bugs Fixed**: Bug #5 (CRITICAL) and Bug #6 (MEDIUM)  
**Status**: ‚úÖ Implementation Complete

---

## Executive Summary

Fixed critical bug where batch job conversations were generated with incorrect persona data. User submitted "David Chen" but system generated "Marcus Chen" because:
1. **Root Cause**: Batch processing passed UUIDs to Claude instead of resolved persona names
2. **Secondary Issue**: Storage layer didn't validate Claude's output against input parameters

**Impact**: All future batch jobs will now use correct persona data, and JSON files will contain audit trail of input parameters.

---

## Bug #5: Input Parameter Resolution (CRITICAL üî¥)

### Problem
The `process-next` route passed raw UUIDs to the generation service, but templates expected resolved values like `{{persona_name}}`, `{{persona_archetype}}`, etc. Claude received unresolved placeholders and hallucinated persona details.

**Evidence**:
- Template had: `**Client Persona:** {{persona_name}} - {{persona_archetype}}`
- Claude received: Literal `{{persona_name}}` text (not "David Chen")
- Claude invented: "Marcus Chen" based on context clues

### Solution Implemented

**File**: `src/app/api/batch-jobs/[id]/process-next/route.ts`

**Changes**:
1. Added imports for scaffolding services:
   ```typescript
   import { ScaffoldingDataService } from '@/lib/services/scaffolding-data-service';
   import { ParameterAssemblyService } from '@/lib/services/parameter-assembly-service';
   import { TemplateSelectionService } from '@/lib/services/template-selection-service';
   ```

2. Added parameter validation before generation:
   ```typescript
   // Validate required parameters
   if (!item.parameters?.persona_id) {
     throw new Error('Missing required parameter: persona_id');
   }
   // ... similar for emotional_arc_id and training_topic_id
   ```

3. Instantiated services and resolved parameters using `ParameterAssemblyService`:
   ```typescript
   const supabase = createServerSupabaseAdminClient();
   const scaffoldingService = new ScaffoldingDataService(supabase);
   const templateSelectionService = new TemplateSelectionService(supabase);
   const parameterAssemblyService = new ParameterAssemblyService(
     scaffoldingService,
     templateSelectionService
   );

   const assembled = await parameterAssemblyService.assembleParameters({
     persona_id: item.parameters.persona_id,
     emotional_arc_id: item.parameters.emotional_arc_id,
     training_topic_id: item.parameters.training_topic_id,
     tier: item.tier,
     template_id: templateId,
     created_by: job.createdBy,
   });
   ```

4. Pass RESOLVED parameters to generation service:
   ```typescript
   const result = await generationService.generateSingleConversation({
     templateId,
     parameters: assembled.template_variables, // ‚Üê NOT just UUIDs!
     tier: item.tier,
     userId: job.createdBy || '00000000-0000-0000-0000-000000000000',
     runId: jobId,
   });
   ```

5. Added scaffolding provenance to conversation record:
   - Updates conversation with `persona_id`, `emotional_arc_id`, `training_topic_id`
   - Stores `scaffolding_snapshot` with full persona/arc/topic details
   - Includes compatibility score and system prompt used

**Pattern Used**: Same pattern as `generate-with-scaffolding` route (known working implementation)

**Result**: Claude now receives fully resolved persona names and details, eliminating hallucination.

---

## Bug #6: Storage Validation & Audit Trail (MEDIUM üü°)

### Problem
Even if Claude received correct persona (after Bug #5 fix), the storage service would store Claude's `client_persona` field without validation. No audit trail of original input parameters.

### Solution Implemented - Part 1: Type Definition

**File**: `src/lib/services/conversation-schema.ts`

**Changes**:
Added `input_parameters` field to `ConversationJSON` type:
```typescript
export type ConversationJSON = {
  conversation_metadata: { ... };
  turns: Array<{ ... }>;
  // Added post-generation for audit trail
  input_parameters?: {
    persona_id: string;
    persona_key: string;
    persona_name: string;
    emotional_arc_id: string;
    emotional_arc_key: string;
    emotional_arc_name: string;
    training_topic_id: string;
    training_topic_key: string;
    training_topic_name: string;
  };
};
```

**Note**: NOT added to Claude's schema (which enforces `additionalProperties: false`) because this field is injected post-generation, not generated by Claude.

### Solution Implemented - Part 2: Storage Service

**File**: `src/lib/services/conversation-storage-service.ts`

**Changes**:
Added validation step in `parseAndStoreFinal()` method after JSON parsing (Step 4.5):

```typescript
// STEP 4.5: Fetch scaffolding data and override client_persona (BUG FIX #6)
console.log(`[parseAndStoreFinal] Fetching scaffolding data to validate persona...`);

// Fetch conversation record to get scaffolding IDs
const { data: convRecord } = await this.supabase
  .from('conversations')
  .select('persona_id, emotional_arc_id, training_topic_id')
  .eq('conversation_id', conversationId)
  .single();

if (convRecord?.persona_id) {
  // Fetch actual persona data
  const { data: persona } = await this.supabase
    .from('personas')
    .select('id, name, archetype, persona_key')
    .eq('id', convRecord.persona_id)
    .single();

  // ... similar for arc and topic

  if (persona) {
    // Override Claude's generated persona with the actual input persona
    const correctPersona = `${persona.name} - ${persona.archetype}`;
    const originalPersona = parsed.conversation_metadata?.client_persona;
    
    if (originalPersona !== correctPersona) {
      console.log(`[parseAndStoreFinal] ‚ö†Ô∏è  Persona mismatch detected!`);
      console.log(`[parseAndStoreFinal]   Claude generated: "${originalPersona}"`);
      console.log(`[parseAndStoreFinal]   Correct persona: "${correctPersona}"`);
      console.log(`[parseAndStoreFinal]   Overriding with correct persona...`);
      
      parsed.conversation_metadata.client_persona = correctPersona;
    }

    // Add input_parameters section for audit trail
    parsed.input_parameters = {
      persona_id: convRecord.persona_id,
      persona_key: persona.persona_key,
      persona_name: persona.name,
      // ... arc and topic details
    };
  }
}
```

**Result**: JSON files now contain validated `client_persona` and complete `input_parameters` section for audit trail.

### Solution Implemented - Part 3: Enrichment Service

**File**: `src/lib/services/conversation-enrichment-service.ts`

**Changes**:

1. Added `archetype` to persona fetch:
   ```typescript
   const { data } = await this.supabase
     .from('personas')
     .select('name, archetype, demographics, financial_background') // Added archetype
     .eq('id', conversation.persona_id)
     .single();
   ```

2. Updated `buildTrainingPair()` to use database persona:
   ```typescript
   // Use database persona name if available (BUG FIX #6)
   // This ensures consistency even if Claude's output was incorrect
   const client_persona = dbMetadata.persona 
     ? `${dbMetadata.persona.name} - ${dbMetadata.persona.archetype || 'Client'}`
     : conversationMetadata.client_persona;

   return {
     // ...
     conversation_metadata: {
       client_persona, // Use validated persona from database
       // ...
     },
   };
   ```

**Result**: Training pairs use validated persona from database, ensuring consistency across all enriched data.

---

## Files Modified

| File | Lines Changed | Purpose |
|------|---------------|---------|
| `src/app/api/batch-jobs/[id]/process-next/route.ts` | ~80 lines | Fix input resolution - use ParameterAssemblyService |
| `src/lib/services/conversation-schema.ts` | +11 lines | Add input_parameters type |
| `src/lib/services/conversation-storage-service.ts` | +77 lines | Validate persona and add audit trail |
| `src/lib/services/conversation-enrichment-service.ts` | +8 lines | Use database persona in training pairs |

**Total**: ~176 lines added/modified across 4 files

---

## Testing Instructions

### Manual Test Plan

1. **Create a new batch job** with "David Chen" persona via the batch-jobs UI

2. **Process the batch** and wait for completion

3. **Verify the generated conversation**:
   - Download the raw JSON file
   - Check `conversation_metadata.client_persona` contains "David Chen - [Archetype]"
   - Check `input_parameters` section exists with correct IDs
   - Verify conversation content references teacher income ($65k-$85k), not tech worker

4. **Check the database**:
   ```sql
   SELECT 
     c.conversation_id,
     c.conversation_name,
     c.persona_id,
     p.name as persona_name,
     c.scaffolding_snapshot
   FROM conversations c
   JOIN personas p ON c.persona_id = p.id
   WHERE c.conversation_id = '[YOUR_CONVERSATION_ID]';
   ```
   - Verify `persona_id` matches David Chen's UUID
   - Verify `conversation_name` matches `persona_name`
   - Verify `scaffolding_snapshot` contains correct persona data

5. **Verify enrichment**:
   - Trigger enrichment for the conversation
   - Download enriched JSON
   - Check all `training_pairs[].conversation_metadata.client_persona` use "David Chen"

### Expected Results

- ‚úÖ `conversation_metadata.client_persona` = "David Chen - Pragmatic Optimist"
- ‚úÖ `input_parameters.persona_name` = "David Chen"
- ‚úÖ Conversation content references David Chen's characteristics (teacher, $65k-$85k)
- ‚úÖ Database `conversations.persona_id` = David Chen's UUID
- ‚úÖ Enriched training pairs all use "David Chen"

---

## Key Learnings

1. **Batch processing had diverged from single-generation pattern**: The `generate-with-scaffolding` route was working correctly, but batch processing had a different implementation that skipped parameter resolution.

2. **Template resolver doesn't fetch data**: The template resolver only does string substitution - it doesn't look up scaffolding data from the database. This must be done before calling the generation service.

3. **Two-layer validation needed**: 
   - Layer 1 (Bug #5): Ensure correct data goes TO Claude
   - Layer 2 (Bug #6): Validate what comes BACK from Claude

4. **Audit trail critical for debugging**: The `input_parameters` section makes it trivial to identify parameter mismatches in the future.

---

## Rollback Plan

If issues are discovered:

1. **Revert `process-next/route.ts`**:
   ```bash
   git checkout HEAD~1 -- src/app/api/batch-jobs/[id]/process-next/route.ts
   ```

2. **Revert storage/enrichment changes**:
   ```bash
   git checkout HEAD~1 -- src/lib/services/conversation-storage-service.ts
   git checkout HEAD~1 -- src/lib/services/conversation-enrichment-service.ts
   git checkout HEAD~1 -- src/lib/services/conversation-schema.ts
   ```

3. **Redeploy** to Vercel

**Note**: Any conversations generated with the bug will still have incorrect data. Consider running a migration script to fix historical data if needed.

---

## Future Enhancements

1. **Validation Report**: Add a `validation_report` section to JSON showing any corrections made
2. **Migration Script**: Create script to fix historical conversations with persona mismatches
3. **Monitoring**: Add alerts when persona overrides occur (indicates template issues)
4. **Template Validation**: Pre-validate templates ensure all required placeholders are present

---

**Implementation Status**: ‚úÖ COMPLETE - Ready for testing

