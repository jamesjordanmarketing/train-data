# Context Carryover: Bulk Generation Pipeline - FK Constraint Fix

**Date Updated:** November 27, 2025  
**Previous Session Focus:** Enrichment ID Mismatch Fix (deployed)  
**Current Session Focus:** FK Constraint Violation Investigation (COMPLETE)  
**Current Status:** üìã INVESTIGATION COMPLETE - Ready for Implementation

---

## üìã Project Context

### What This Application Does

**Bright Run LoRA Training Data Platform** - A Next.js 14 application that generates high-quality AI training conversations for fine-tuning large language models. The platform enables non-technical domain experts to transform proprietary knowledge into LoRA-ready training datasets.

**Core Capabilities**:
1. **Conversation Generation**: AI-powered generation using Claude API with predetermined field structure
2. **Enrichment Pipeline**: 5-stage validation and enrichment process for quality assurance
3. **Storage System**: File storage (Supabase Storage) + metadata (PostgreSQL)
4. **Management Dashboard**: UI for reviewing, downloading, and managing conversations
5. **Download System**: Export both raw (minimal) and enriched (complete) JSON formats

**Technology Stack**:
- Framework: Next.js 14 (App Router)
- Language: TypeScript
- Database: Supabase (PostgreSQL)
- Storage: Supabase Storage
- AI: Claude API (Anthropic)
- UI: Shadcn/UI + Tailwind CSS
- Deployment: Vercel

### Core Workflow

```
User ‚Üí Generate Conversation ‚Üí Claude API ‚Üí Raw JSON Stored ‚Üí
Enrichment Pipeline (5 stages) ‚Üí Enriched JSON Stored ‚Üí
Dashboard View ‚Üí Download (Raw or Enriched)
```

---

## üö® CURRENT SESSION SUMMARY

### What We Did This Session

**Investigation ONLY** - No code changes were made. User explicitly requested:
> "in this iteration do NOT FIX ANYTHING - Your only job is to examine the entire codebase and Supabase data, schema, objects (constraints, triggers etc) and figure out what is broken"

### Issue Investigated

**User Report:** Ran a batch job of 4 conversation generations. ALL 4 FAILED with "Unknown error"

**Job ID:** `e7f0fdf9-ca4a-4a63-82a3-5907d049bb37`

### Root Cause Discovered

**The Bug:** There's a **Foreign Key constraint mismatch**. The `conversations` table has TWO UUID columns:

| Column | Type | Purpose |
|--------|------|---------|
| `id` | UUID | **Primary Key** - Auto-generated by PostgreSQL |
| `conversation_id` | UUID | **Business Key** - Passed in from generation service |

**These are DIFFERENT values!**

The FK constraint on `batch_items`:
```sql
batch_items.conversation_id REFERENCES conversations(id) ON DELETE CASCADE
```

The code was inserting `conversations.conversation_id` (business key) instead of `conversations.id` (PK).

### Key Evidence

1. **Conversations ARE generated successfully** - Files exist in Storage, records exist in DB
2. **Failure happens at `incrementProgress`** - When trying to update `batch_items.conversation_id`
3. **Database proof:**
   ```
   conversation_id: b3a5850f-591a-4463-96d4-4396f18b5694  (business key)
                id: b77ffcfc-6738-4e94-849c-b07c5cf484f0  (PK - DIFFERENT!)
   ```

### Specification Document Created

üìÑ **Full specification written to:**
```
pmc/context-ai/pmct/iteration-1-bug-fixing-step-9_v1.md
```

This document contains:
- Complete root cause analysis
- Code flow analysis with file locations and line numbers
- Database evidence
- Two fix options with code examples
- Secondary bug: UI logging issue
- Testing checklist

---

## üéØ NEXT AGENT INSTRUCTIONS

### Primary Task: Implement the Fixes

**Read the full specification first:**
```
pmc/context-ai/pmct/iteration-1-bug-fixing-step-9_v1.md
```

### Fix #1: Foreign Key Constraint (PRIORITY 1 - BLOCKING)

**Recommended Approach (Option A from spec):**

Modify `conversation-generation-service.ts` to return BOTH IDs:

```typescript
return {
  conversation: result.conversation,
  conversationId: result.conversation.conversation_id,
  conversationPK: result.conversation.id, // ADD THIS
  // ...
};
```

Then modify `process-next/route.ts` to use the PK:

```typescript
const updateResult = await batchJobService.incrementProgress(
  jobId,
  item.id,
  true,
  result.conversationPK, // Use PK, not business key
  errorMessage
);
```

**Files to Modify:**
1. `src/lib/services/conversation-generation-service.ts` - Return both IDs
2. `src/app/api/batch-jobs/[id]/process-next/route.ts` - Use PK for FK

### Fix #2: UI Logging (PRIORITY 2 - Quality of Life)

User requested logs be removed from UI and written to Supabase Storage instead.

**Files to Modify:**
1. `src/app/(dashboard)/batch-jobs/[id]/page.tsx` - Remove `processLogs` UI component
2. API route or service - Write logs to `batch-logs` Storage bucket

---

## üìÅ Key Files Reference

| File | Purpose |
|------|---------|
| `pmc/context-ai/pmct/iteration-1-bug-fixing-step-9_v1.md` | **FULL BUG SPECIFICATION** |
| `src/app/api/batch-jobs/[id]/process-next/route.ts` | Polling endpoint, passes wrong ID |
| `src/lib/services/batch-job-service.ts` | Updates batch_items with FK value |
| `src/lib/services/conversation-generation-service.ts` | Returns conversation IDs |
| `src/lib/services/conversation-storage-service.ts` | Creates conversation records |
| `src/app/(dashboard)/batch-jobs/[id]/page.tsx` | UI with logging issue |
| `pmc/context-ai/pmct/batch-runtime-15.csv` | Runtime error log |

---

## üß™ Testing Checklist (Post-Implementation)

### Pre-Fix Verification
- [ ] Confirm `conversations` table has both `id` and `conversation_id` columns
- [ ] Confirm FK constraint definition: `batch_items.conversation_id ‚Üí conversations.id`

### Post-Fix: FK Constraint
- [ ] Run batch job with 2-3 items
- [ ] Verify all items complete successfully
- [ ] Query `batch_items` - all should have valid `conversation_id` FK
- [ ] Query `conversations` - verify `id` column matches `batch_items.conversation_id`

### Post-Fix: Logging
- [ ] Verify no `processLogs` component in UI
- [ ] Verify logs appear in Storage bucket `batch-logs/{jobId}/log.txt`
- [ ] Verify UI doesn't "rewrite" during processing

---

## üóÑÔ∏è Database Schema Reference

### conversations Table (Critical Columns)

| Column | Type | Purpose |
|--------|------|---------|
| `id` | UUID | **PostgreSQL auto-generated PK** ‚Üê FK TARGET |
| `conversation_id` | UUID | Business UUID (from generationId) |
| `created_by` | UUID | User who created |
| `processing_status` | TEXT | Current state |

### batch_items Table (Critical Columns)

| Column | Type | Purpose |
|--------|------|---------|
| `id` | UUID | Item ID |
| `job_id` | UUID | Parent batch job |
| `conversation_id` | UUID | **FK ‚Üí conversations.id** (NOT conversation_id!) |
| `status` | TEXT | pending/completed/failed |

---

## üîÑ Issue History (This Sprint)

| Issue | Status | Session |
|-------|--------|---------|
| CHECK constraint on batch_jobs.status | ‚úÖ Fixed | Earlier |
| Template NIL_UUID not found | ‚úÖ Fixed | Earlier |
| Enrichment "Conversation not found" | ‚úÖ Fixed | Previous (11/26) |
| **FK Constraint Violation** | üìã Investigated | **Current (11/27)** |
| **UI Log Rendering Issue** | üìã Investigated | **Current (11/27)** |

---

## üö® CRITICAL: SAOL Tool Usage (MUST READ)

**The Supabase Client is unreliable for administrative tasks due to RLS (Row Level Security).**
**You MUST use the Supabase Agent Ops Library (SAOL) for all database operations.**

### ‚úÖ CORRECT SAOL USAGE PATTERN

SAOL is a **Functional API**, not a class.

**1. Import Pattern (in scripts):**
Use the local `load-env.js` to ensure environment variables are loaded correctly.

```javascript
// ‚úÖ CORRECT IMPORT (in scripts/ folder)
require('../load-env.js'); 
const saol = require('../supa-agent-ops/dist/index.js');

// ‚ùå INCORRECT
// require('dotenv').config(); // Fails to find module often
// const saol = new SupabaseAgentOpsLibrary(); // It is NOT a class
```

**2. Querying Data (agentQuery):**
Use `agentQuery` for reading data. It works over the HTTP API and is robust.

```javascript
const result = await saol.agentQuery({
  table: 'batch_jobs',
  supabaseUrl: process.env.NEXT_PUBLIC_SUPABASE_URL,
  supabaseKey: process.env.SUPABASE_SERVICE_ROLE_KEY,
  where: [{ column: 'status', operator: 'eq', value: 'failed' }],
  limit: 5,
  transport: 'supabase' // CRITICAL: Use 'supabase' transport
});

if (result.success) {
  console.log(result.data);
}
```

**3. Introspection (agentIntrospectSchema):**
‚ö†Ô∏è **WARNING**: `agentIntrospectSchema` often requires `transport: 'pg'` and a direct `DATABASE_URL` connection string, which may not be available.
**Better Approach**: Use "Probe Queries" with `agentQuery` to check if columns exist (select specific columns with `limit: 1`).

---

## ‚ö†Ô∏è Important Context Notes

1. **Previous fix may have introduced this bug** - The 11/26 fix changed ID handling to use `conversation_id` (business key) which the FK constraint doesn't accept

2. **The conversations ARE being generated** - This is NOT a generation failure, it's a FK update failure

3. **User doesn't want logging in UI** - Remove the `processLogs` state and component, write to Storage instead

4. **Test URL:** https://train-data-three.vercel.app/bulk-generator

---

**Document Version:** 2.0  
**Session Date:** November 27, 2025  
**Author:** AI Agent (Claude Opus 4.5)  
**Classification:** Internal Development Use
